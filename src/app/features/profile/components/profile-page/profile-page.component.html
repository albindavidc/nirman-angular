<div class="profile-container">
  <!-- Header -->
  <div class="header">
    <div class="title-section">
      <div class="icon-wrapper">
        <mat-icon>person</mat-icon>
      </div>
      <div>
        <h1>My Profile</h1>
        <p class="subtitle">Manage your account information</p>
      </div>
    </div>
  </div>

  @if (isLoading) {
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
  } @else if (profile) {
  <div class="profile-content">
    <!-- Profile Card -->
    <mat-card class="profile-card">
      <mat-card-content>
        <div class="profile-header">
          <!-- Clickable Avatar -->
          <div class="avatar-upload-wrapper" (click)="openUploadModal()">
            @if (getProfilePhotoUrl()) {
            <img
              [src]="getProfilePhotoUrl()"
              alt="Profile Photo"
              class="avatar-large avatar-image"
            />
            } @else {
            <div class="avatar-large">
              {{ getInitials() }}
            </div>
            }
            <div class="avatar-overlay">
              @if (isUploadingPhoto) {
              <mat-spinner diameter="24" color="primary"></mat-spinner>
              } @else {
              <mat-icon>camera_alt</mat-icon>
              }
            </div>
          </div>

          <div class="profile-meta">
            <h2>{{ profile.firstName }} {{ profile.lastName }}</h2>
            <span class="role-badge">{{ profile.role | titlecase }}</span>
            <p class="email">{{ profile.email }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Edit Profile Form -->
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>edit</mat-icon>
          Edit Profile
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="profileForm" (ngSubmit)="onSaveProfile()">
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>First Name</mat-label>
              <input matInput formControlName="firstName" />
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Last Name</mat-label>
              <input matInput formControlName="lastName" />
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Phone Number</mat-label>
            <input matInput formControlName="phoneNumber" />
            <mat-icon matPrefix>phone</mat-icon>
          </mat-form-field>

          <div class="form-actions">
            <button
              mat-flat-button
              color="primary"
              type="submit"
              [disabled]="profileForm.invalid || isSaving"
            >
              @if (isSaving) {
              <mat-spinner diameter="20"></mat-spinner>
              } @else {
              <ng-container>
                <mat-icon>save</mat-icon>
                Save Changes
              </ng-container>
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Change Password Form -->
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>lock</mat-icon>
          Change Password
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Current Password</mat-label>
            <input
              matInput
              formControlName="currentPassword"
              [type]="hideCurrentPassword ? 'password' : 'text'"
            />
            <mat-icon matPrefix>lock</mat-icon>
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="hideCurrentPassword = !hideCurrentPassword"
            >
              <mat-icon>{{
                hideCurrentPassword ? "visibility_off" : "visibility"
              }}</mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>New Password</mat-label>
            <input
              matInput
              formControlName="newPassword"
              [type]="hideNewPassword ? 'password' : 'text'"
            />
            <mat-icon matPrefix>lock_outline</mat-icon>
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="hideNewPassword = !hideNewPassword"
            >
              <mat-icon>{{
                hideNewPassword ? "visibility_off" : "visibility"
              }}</mat-icon>
            </button>
            <mat-hint>Minimum 8 characters</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirm New Password</mat-label>
            <input
              matInput
              formControlName="confirmPassword"
              [type]="hideConfirmPassword ? 'password' : 'text'"
            />
            <mat-icon matPrefix>lock_outline</mat-icon>
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="hideConfirmPassword = !hideConfirmPassword"
            >
              <mat-icon>{{
                hideConfirmPassword ? "visibility_off" : "visibility"
              }}</mat-icon>
            </button>
          </mat-form-field>

          <div class="form-actions">
            <button
              mat-flat-button
              color="warn"
              type="submit"
              [disabled]="passwordForm.invalid || isChangingPassword"
            >
              @if (isChangingPassword) {
              <mat-spinner diameter="20"></mat-spinner>
              } @else {
              <ng-container>
                <mat-icon>vpn_key</mat-icon>
                Change Password
              </ng-container>
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
  }
</div>
