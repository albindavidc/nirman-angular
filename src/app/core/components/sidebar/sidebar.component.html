<aside class="sidebar" [class.collapsed]="layoutService.isSidebarCollapsed()">
  <!-- Toggle Button -->
  <button class="toggle-btn" mat-icon-button (click)="toggleSidebar()">
    <mat-icon>menu</mat-icon>
  </button>

  <!-- Navigation -->
  <nav class="nav-menu">
    @for (item of navItems$ | async; track item.label) { @if (item.children) {
    <!-- Parent with children (Popup Menu) -->
    <!-- Parent with children -->
    <div class="nav-group">
      <!-- Case 1: Sidebar Collapsed - Use Popup Menu -->
      @if (layoutService.isSidebarCollapsed()) {
      <button
        class="nav-item parent collapsed-mode"
        [matMenuTriggerFor]="submenu"
        #menuTrigger="matMenuTrigger"
        [class.active]="menuTrigger.menuOpen"
      >
        <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
      </button>

      <mat-menu #submenu="matMenu" class="sidebar-submenu-popup">
        @for (child of item.children; track child.label) {
        <a
          mat-menu-item
          [routerLink]="child.route"
          routerLinkActive="active"
          class="submenu-item"
        >
          <mat-icon>{{ child.icon }}</mat-icon>
          <span>{{ child.label }}</span>
        </a>
        }
      </mat-menu>
      }

      <!-- Case 2: Sidebar Expanded - Use Inline Accordion -->
      @else {
      <button
        class="nav-item parent expanded-mode"
        (click)="toggleSubmenu(item.label)"
        [class.expanded]="isMenuExpanded(item.label)"
      >
        <div class="nav-content">
          <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
          <span class="nav-label">{{ item.label }}</span>
        </div>
        <mat-icon class="chevron">
          {{ isMenuExpanded(item.label) ? "expand_less" : "expand_more" }}
        </mat-icon>
      </button>

      @if (isMenuExpanded(item.label)) {
      <div class="submenu-inline">
        @for (child of item.children; track child.label) {
        <a
          class="nav-item child"
          [routerLink]="child.route"
          routerLinkActive="active"
        >
          <mat-icon class="nav-icon">{{ child.icon }}</mat-icon>
          <span class="nav-label">{{ child.label }}</span>
        </a>
        }
      </div>
      } }
    </div>
    } @else {
    <!-- Simple nav item -->
    <a class="nav-item" [routerLink]="item.route" routerLinkActive="active">
      <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
      @if (!layoutService.isSidebarCollapsed()) {
      <span class="nav-label">{{ item.label }}</span>
      }
    </a>
    } }
  </nav>

  <!-- User Profile -->
  @if (user$ | async; as user) {
  <a routerLink="/profile" class="user-profile-link">
    <div class="user-profile">
      @if (user.profilePhotoUrl) {
      <img
        [src]="getProfilePhotoUrl(user.profilePhotoUrl)"
        alt="Profile"
        class="avatar avatar-image"
      />
      } @else {
      <div class="avatar">
        {{ getInitials(user.firstName, user.lastName) }}
      </div>
      } @if (!layoutService.isSidebarCollapsed()) {
      <div class="user-info">
        <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
        <span class="user-role">{{ user.role | titlecase }}</span>
      </div>
      }
    </div>
  </a>
  }
</aside>
